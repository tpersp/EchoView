<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Display</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div id="background"></div>
<div id="container"></div>
<div id="spotify">
    <img id="album" src=""><br>
    <span id="artist"></span> - <span id="title"></span>
    <div class="progress-container">
        <div id="progress"></div>
    </div>
</div>
<script>
let current = '';
let queue = [];
let qIndex = 0;
let preloaded = {};
function showMedia(file){
    const container = document.getElementById('container');
    const bg = document.getElementById('background');
    container.innerHTML = '';
    if(!file){
        bg.style.backgroundImage='';
        container.innerHTML = '<div class="no-media">No media available</div>';
        return;
    }
    const url = file.startsWith('http')?file:'/media/'+file;
    const ext = file.split('.').pop().toLowerCase();
    if(['mp4','webm','ogg'].includes(ext)){
        const vid=document.createElement('video');
        vid.src=url;
        vid.autoplay=true;
        vid.loop=true;
        vid.controls=false;
        container.appendChild(vid);
        bg.style.backgroundImage='url("'+url+'");'
    } else if(['html','htm'].includes(ext)){
        const frame=document.createElement('iframe');
        frame.src=url;
        container.appendChild(frame);
        bg.style.backgroundImage='';
    } else {
        const img=document.createElement('img');
        img.src=url;
        container.appendChild(img);
        bg.style.backgroundImage='url("'+url+'");'
    }
}
function showSpotify(stat){
    const s=document.getElementById('spotify');
    s.style.display='block';
    document.getElementById('album').src=stat.album_image;
    document.getElementById('artist').textContent=stat.artist;
    document.getElementById('title').textContent=stat.title;
    if(stat.duration_ms>0){
        document.getElementById('progress').style.width=(stat.progress_ms/stat.duration_ms*100)+'%';
    }
}
async function loadQueue(){
    const res = await fetch('/api/smb/mix');
    const data = await res.json();
    queue = data.files || [];
    qIndex = 0;
    updatePreload();
}

function updatePreload(){
    const needed = [];
    for(let i=0;i<3 && i<queue.length;i++){
        const idx = (qIndex+i)%queue.length;
        needed.push(queue[idx]);
        const f = queue[idx];
        if(!preloaded[f]){
            const ext = f.split('.').pop().toLowerCase();
            const url = '/media/'+f;
            if(['mp4','webm','ogg'].includes(ext)){
                const v=document.createElement('video');
                v.src=url;
            }else{
                const img=new Image();
                img.src=url;
            }
            preloaded[f]=true;
        }
    }
    for(const f in preloaded){
        if(!needed.includes(f)) delete preloaded[f];
    }
}

function nextFromQueue(){
    if(queue.length===0) return null;
    const f = queue[qIndex];
    qIndex = (qIndex+1)%queue.length;
    updatePreload();
    return f;
}

async function poll(){
    const [dispRes, spotRes] = await Promise.all([
        fetch('/api/display'),
        fetch('/api/spotify/status')
    ]);
    const data = await dispRes.json();
    const sp = await spotRes.json();
    const spot = sp.status;
    if(spot.playing){
        if(current !== 'spotify'){ current='spotify'; }
        showSpotify(spot);
    } else {
        document.getElementById('spotify').style.display='none';
        let target = data.file || sp.fallback;
        if(!target){
            if(queue.length===0) await loadQueue();
            target = nextFromQueue();
        }
        if(target){
            if(target !== current){
                current = target;
                showMedia(target);
            }
        } else if(current !== '') {
            current = '';
            showMedia(null);
        }
    }
}
setInterval(poll, 5000);
poll();
</script>
</body>
</html>
