{% extends "base.html" %}
{% block title %}Viewer Controller{% endblock %}
{% block content %}

<div class="page-section" style="max-width:1200px;">

  <!-- Top info row -->
  <div style="text-align:center; display:flex; flex-wrap:wrap; gap:20px; margin-bottom:10px;">
    <div>Hostname: {{ host }}</div>
    <div>IP: {{ ipaddr }}</div>
    <div>CPU: <span id="stat_cpu">{{ cpu }}%</span></div>
    <div>Mem: <span id="stat_mem">{{ mem_line }}MB</span></div>
    <div>Temp: <span id="stat_temp">{{ temp }}</span></div>
    <div>Storage: <span id="stat_disk">{{ disk_usage }}</span></div>
    {% if sub_info_line %}
      <div>{{ sub_info_line }}</div>
    {% endif %}
  </div>

  <!-- Multi-monitor: one card per display -->
  <form method="POST">
    <input type="hidden" name="action" value="update_displays">
    <div class="row g-3">
      {% for dname, dcfg in cfg.displays.items() %}
      <div class="col d-flex">
        <div class="card h-100 flex-fill text-center">
        <h3>{{ dname }} ({{ monitors.get(dname, {}).get('resolution', 'Unknown') }})</h3>
        <!-- Display Settings for this monitor -->
        <div>
          <!-- Mode -->
          <label>Mode:</label><br>
          <select name="{{ dname }}_mode" id="{{ dname }}_mode">
            <option value="random_image"   {% if dcfg.mode=="random_image" %}selected{% endif %}>Random Image/GIF</option>
            <option value="specific_image" {% if dcfg.mode=="specific_image" %}selected{% endif %}>Specific Image/GIF</option>
            <option value="mixed"          {% if dcfg.mode=="mixed" %}selected{% endif %}>Mixed (Multiple Folders)</option>
            <option value="videos"         {% if dcfg.mode=="videos" %}selected{% endif %}>Videos</option>
            <option value="spotify"        {% if dcfg.mode=="spotify" %}selected{% endif %}>Spotify Now Playing</option>
            <option value="web_page"       {% if dcfg.mode=="web_page" %}selected{% endif %}>Web Page</option>
          </select>
          <br><br>

          <!-- Spotify Settings -->
          <div id="{{ dname }}_spotify_section" class="mode-section">
            <label>Fallback Mode:</label><br>
            <select name="{{ dname }}_fallback_mode">
              <option value="random_image"   {% if dcfg.fallback_mode=="random_image" %}selected{% endif %}>Random Image/GIF</option>
              <option value="specific_image" {% if dcfg.fallback_mode=="specific_image" %}selected{% endif %}>Specific Image/GIF</option>
              <option value="mixed"          {% if dcfg.fallback_mode=="mixed" %}selected{% endif %}>Mixed (Multiple Folders)</option>
              <option value="none"           {% if dcfg.fallback_mode=="none" %}selected{% endif %}>None</option>
            </select>
            <br><br>
            <!-- Spotify Info Options as inline checkboxes -->
            <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
              <label style="display:inline-block;">
                <input type="checkbox" name="{{ dname }}_spotify_show_song" value="1" {% if dcfg.spotify_show_song is not defined or dcfg.spotify_show_song %}checked{% endif %}>
                Song Title
              </label>
              <label style="display:inline-block;">
                <input type="checkbox" name="{{ dname }}_spotify_show_artist" value="1" {% if dcfg.spotify_show_artist is not defined or dcfg.spotify_show_artist %}checked{% endif %}>
                Artist
              </label>
              <label style="display:inline-block;">
                <input type="checkbox" name="{{ dname }}_spotify_show_album" value="1" {% if dcfg.spotify_show_album is not defined or dcfg.spotify_show_album %}checked{% endif %}>
                Album
              </label>
              <label style="display:inline-block;">
                <input type="checkbox" name="{{ dname }}_spotify_show_progress" value="1" {% if dcfg.spotify_show_progress is defined and dcfg.spotify_show_progress %}checked{% endif %}>
                Live Playback Progress
              </label>
              <label style="display:inline-block;">
                <input type="checkbox" class="spotify-negative-font" id="{{ dname }}_spotify_negative_font" name="{{ dname }}_spotify_negative_font" value="1" {% if dcfg.spotify_negative_font is not defined or dcfg.spotify_negative_font %}checked{% endif %}>
                Auto Negative Font
              </label>
              <span id="{{ dname }}_spotify_font_color_container" style="display:inline-block; margin-left:10px;">
                <label>Font Color:</label>
                <input type="color" name="{{ dname }}_spotify_font_color" value="{{ dcfg.spotify_font_color|default('#FFFFFF') }}">
              </span>
            </div>
            <br>
            <label>Spotify Font Size:</label>
            <input type="number" name="{{ dname }}_spotify_font_size" value="{{ dcfg.spotify_font_size|default(18) }}" style="width:60px;">
            <br><br>
            <!-- Spotify Info Position Dropdown -->
            <label>Spotify Info Position:</label><br>
            <select name="{{ dname }}_spotify_info_position">
              <option value="top-left" {% if dcfg.spotify_info_position=="top-left" %}selected{% endif %}>Top Left</option>
              <option value="top-center" {% if dcfg.spotify_info_position=="top-center" %}selected{% endif %}>Top Center</option>
              <option value="top-right" {% if dcfg.spotify_info_position=="top-right" %}selected{% endif %}>Top Right</option>
              <option value="bottom-left" {% if dcfg.spotify_info_position=="bottom-left" %}selected{% endif %}>Bottom Left</option>
              <option value="bottom-center" {% if dcfg.spotify_info_position=="bottom-center" or dcfg.spotify_info_position is not defined %}selected{% endif %}>Bottom Center</option>
              <option value="bottom-right" {% if dcfg.spotify_info_position=="bottom-right" %}selected{% endif %}>Bottom Right</option>
            </select>
            <br><br>
            <!-- New: Progress Bar settings -->
            <label>Progress Bar Position:</label><br>
            <select name="{{ dname }}_spotify_progress_position">
              <option value="above_info" {% if dcfg.spotify_progress_position=="above_info" %}selected{% endif %}>Above Info</option>
              <option value="below_info" {% if dcfg.spotify_progress_position=="below_info" or dcfg.spotify_progress_position is not defined %}selected{% endif %}>Below Info</option>
              <option value="top-center" {% if dcfg.spotify_progress_position=="top-center" %}selected{% endif %}>Top Center</option>
              <option value="bottom-center" {% if dcfg.spotify_progress_position=="bottom-center" %}selected{% endif %}>Bottom Center</option>
            </select>
            <br><br>
            <label>Progress Bar Theme:</label><br>
            <select name="{{ dname }}_spotify_progress_theme">
              <option value="dark" {% if dcfg.spotify_progress_theme=="dark" or dcfg.spotify_progress_theme is not defined %}selected{% endif %}>Dark</option>
              <option value="spotify" {% if dcfg.spotify_progress_theme=="spotify" %}selected{% endif %}>Spotify</option>
              <option value="coffee" {% if dcfg.spotify_progress_theme=="coffee" %}selected{% endif %}>Coffee</option>
              <option value="light" {% if dcfg.spotify_progress_theme=="light" %}selected{% endif %}>Light</option>
            </select>
            <br><br>
          </div>

          <!-- Random/Mixed Settings -->
          <div id="{{ dname }}_random_section" class="mode-section">
            <label>Interval (sec):</label><br>
            <input type="number" name="{{ dname }}_image_interval" value="{{ dcfg.image_interval }}">
            <br><br>
            <label>Shuffle?</label><br>
            <select name="{{ dname }}_shuffle_mode">
              <option value="yes" {% if dcfg.shuffle_mode %}selected{% endif %}>Yes</option>
              <option value="no"  {% if not dcfg.shuffle_mode %}selected{% endif %}>No</option>
            </select>
            <br><br>
          </div>

          <!-- Rotate -->
          <label>Rotate (degrees):</label><br>
          <input type="number" name="{{ dname }}_rotate" value="{{ dcfg.rotate|default(0) }}">
          <br><br>

          <!-- Aspect Filter -->
          <label>Aspect Filter:</label><br>
          <select name="{{ dname }}_aspect_filter">
            <option value="any" {% if dcfg.aspect_filter is not defined or dcfg.aspect_filter=='any' %}selected{% endif %}>Any</option>
            <option value="square" {% if dcfg.aspect_filter=='square' %}selected{% endif %}>1:1 (Square)</option>
            <option value="landscape" {% if dcfg.aspect_filter=='landscape' %}selected{% endif %}>16:9 (Landscape)</option>
            <option value="portrait" {% if dcfg.aspect_filter=='portrait' %}selected{% endif %}>9:16 (Portrait)</option>
          </select>
          <br><br>

          <!-- Category selection for Random/Specific -->
          <div id="{{ dname }}_category_section" class="mode-section">
            <label>Category (subfolder):</label><br>
            <select name="{{ dname }}_image_category">
              <option value="" {% if not dcfg.image_category %}selected{% endif %}>All</option>
              {% for sf in subfolders %}
                {% set count = folder_counts[sf] %}
                <option value="{{ sf }}" {% if dcfg.image_category==sf %}selected{% endif %}>
                  {{ sf }} ({{ count }} files)
                </option>
              {% endfor %}
            </select>
            <br><br>
          </div>

          <!-- Mixed Folders UI -->
          <div id="{{ dname }}_mixed_section" class="mode-section">
            <label>Multiple Folders (drag to reorder):</label><br>
            <input type="text" placeholder="Search..." id="{{ dname }}_search" style="width:90%;"><br>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <ul id="{{ dname }}_availList" style="flex:1; list-style:none; border:1px solid var(--border-muted); padding:5px;">
                {% for sf in subfolders %}
                  {% if sf not in dcfg.mixed_folders %}
                    <li draggable="true" data-folder="{{ sf }}" style="margin:4px; border:1px solid #666; border-radius:4px; cursor:move; padding:4px;">
                      {{ sf }} ({{ folder_counts[sf] }})
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
              <ul id="{{ dname }}_selList" style="flex:1; list-style:none; border:1px solid var(--border-muted); padding:5px;">
                {% for sf in dcfg.mixed_folders %}
                    <li draggable="true" data-folder="{{ sf }}" style="margin:4px; border:1px solid #666; border-radius:4px; cursor:move; padding:4px;">
                      {{ sf }} ({{ folder_counts[sf]|default(0) }})
                    </li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" name="{{ dname }}_mixed_order" id="{{ dname }}_mixed_order" value="{{ ','.join(dcfg.mixed_folders) }}">
            <br>
          </div>

          <!-- Video Settings -->
          <div id="{{ dname }}_videos_section" class="mode-section">
            <label>Video Category (subfolder):</label><br>
            <select name="{{ dname }}_video_category">
              <option value="" {% if not dcfg.video_category %}selected{% endif %}>All</option>
              {% for sf in subfolders %}
                <option value="{{ sf }}" {% if dcfg.video_category==sf %}selected{% endif %}>
                  {{ sf }} ({{ folder_counts[sf]|default(0) }})
                </option>
              {% endfor %}
            </select>
            <br><br>
            <label>Shuffle Videos?</label><br>
            <select name="{{ dname }}_shuffle_videos">
              <option value="yes" {% if dcfg.shuffle_videos %}selected{% endif %}>Yes</option>
              <option value="no" {% if not dcfg.shuffle_videos %}selected{% endif %}>No</option>
            </select>
            <br><br>
            <label>Mute by Default:</label>
            <input type="checkbox" name="{{ dname }}_video_mute" id="{{ dname }}_video_mute" class="video-mute" value="1" {% if dcfg.video_mute is not defined or dcfg.video_mute %}checked{% endif %}>
            <br><br>
            <div id="{{ dname }}_volume_container">
              <label>Volume:</label>
              <input type="number" name="{{ dname }}_video_volume" value="{{ dcfg.video_volume|default(100) }}" min="0" max="100" style="width:60px;">
              <br><br>
            </div>
            <label>Play to End:</label>
            <input type="checkbox" name="{{ dname }}_video_play_to_end" id="{{ dname }}_video_play_to_end" class="video-play-to-end" value="1" {% if dcfg.video_play_to_end is not defined or dcfg.video_play_to_end %}checked{% endif %}>
            <br><br>
            <div id="{{ dname }}_max_seconds_container">
              <label>Max play seconds:</label>
              <input type="number" name="{{ dname }}_video_max_seconds" value="{{ dcfg.video_max_seconds|default(120) }}" style="width:80px;">
            </div>
            <br>
          </div>

          <!-- Specific Image selection -->
          <div id="{{ dname }}_specific_image_section" class="mode-section">
            <label>Select Image/GIF:</label><br>
            {% set fileList = display_images[dname] %}
            {% if fileList and fileList|length > 100 %}
              <div id="{{ dname }}_lazyContainer" data-files='{{ fileList|tojson }}'>
                <button type="button" onclick="loadSpecificThumbnails('{{ dname }}')">Show Thumbnails</button>
              </div>
            {% else %}
              {% if fileList and fileList|length > 0 %}
              <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
                {% for imgpath in fileList %}
                  {% set bn = imgpath.split('/')[-1] %}
                  <label style="text-align:center; cursor:pointer;">
                    <img src="/thumb/{{ imgpath }}?size=60" loading="lazy" style="width:60px; height:60px; object-fit:cover; border:2px solid #555; border-radius:4px;">
                    <br>
                    <input type="radio" name="{{ dname }}_specific_image" value="{{ bn }}"
                           {% if bn == dcfg.specific_image %}checked{% endif %}>
                    {{ bn }}
                  </label>
                {% endfor %}
              </div>
              {% else %}
                <p>No images found or category is empty. <a href="{{ url_for('main.upload_media') }}">Upload some?</a></p>
              {% endif %}
            {% endif %}
            <br>
          </div>

          <!-- Web Page Settings -->
          <div id="{{ dname }}_web_page_section" class="mode-section">
            <label>Web URL:</label><br>
            {#
              Use a datalist to provide quick access to previously saved
              websites. Users can still enter any URL manually.  Check the
              box below to remember the URL for future use.
            #}
            <input type="text"
                   class="web-url-input"
                   data-display="{{ dname }}"
                   name="{{ dname }}_web_url"
                   list="{{ dname }}_saved_sites"
                   value="{{ dcfg.web_url|default('') }}"
                   style="width:90%;" placeholder="https://example.com">
            <datalist id="{{ dname }}_saved_sites">
              {% if cfg.saved_websites is defined %}
                {% for site in cfg.saved_websites %}
                  {% if site is string %}
                    <option value="{{ site }}">{{ site }}</option>
                  {% elif site.url is defined %}
                    {% set label = site.title or site.provider or site.url %}
                    <option value="{{ site.url }}">{{ label }}</option>
                  {% else %}
                    {% set fallback_url = site.get('url', '') %}
                    {% set label = site.get('title', site.get('provider', fallback_url)) %}
                    <option value="{{ fallback_url }}">{{ label }}</option>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </datalist>
            <div style="margin-top:8px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;">
              <button type="button"
                      class="button small refresh-embed-btn"
                      data-display="{{ dname }}">Refresh Metadata</button>
              <span id="{{ dname }}_embed_status" class="embed-status">
                {% set meta = dcfg.embed_metadata %}
                {% if meta %}
                  {{ meta.embed_type|default('iframe')|capitalize }} detected
                {% else %}
                  No metadata cached
                {% endif %}
              </span>
              <span id="{{ dname }}_embed_error" class="embed-error" style="color:#ff6666;"></span>
            </div>
            <div id="{{ dname }}_embed_metadata" class="embed-metadata" style="margin-top:10px; color: var(--text-normal);">
              {% if meta %}
                {% if meta.title %}
                  <div><strong>{{ meta.title }}</strong></div>
                {% endif %}
                <div>
                  {{ meta.provider|default('Unknown provider') }}
                  {% if meta.content_type %} &mdash; {{ meta.content_type|capitalize }}{% endif %}
                </div>
                {% if meta.thumbnail_url %}
                  <div style="margin-top:6px;">
                    <img src="{{ meta.thumbnail_url }}" alt="thumbnail" style="max-width:200px; border-radius:4px;">
                  </div>
                {% endif %}
                {% if meta.canonical_url %}
                  <div style="margin-top:6px;"><code style="font-size:0.85em;">{{ meta.canonical_url }}</code></div>
                {% endif %}
              {% else %}
                <div style="font-style:italic;">Enter a URL and refresh metadata.</div>
              {% endif %}
            </div>
            <div id="{{ dname }}_youtube_controls"
                 class="youtube-options"
                 data-display="{{ dname }}"
                 style="margin-top:12px; {% if meta and meta.embed_type == 'youtube' %}display:flex; flex-wrap:wrap; justify-content:center; gap:10px;{% else %}display:none;{% endif %}">
              <div style="font-weight:bold; margin-bottom:6px;">YouTube Playback Options</div>
              <label style="margin-right:12px;">
                <input type="checkbox"
                       name="{{ dname }}_youtube_autoplay"
                       {% if dcfg.youtube_autoplay %}checked{% endif %}>
                Autoplay
              </label>
              <label style="margin-right:12px;">
                <input type="checkbox"
                       name="{{ dname }}_youtube_mute"
                       {% if dcfg.youtube_mute %}checked{% endif %}>
                Mute on load
              </label>
              <label style="margin-right:12px;">
                <input type="checkbox"
                       name="{{ dname }}_youtube_captions"
                       {% if dcfg.youtube_captions %}checked{% endif %}>
                Closed captions
              </label>
              <label style="margin-right:12px;">
                Quality:
                <select name="{{ dname }}_youtube_quality">
                  {% set qual = dcfg.youtube_quality|default('default') %}
                  {% set options = [
                    ('default', 'Default'),
                    ('small', '144p'),
                    ('medium', '360p'),
                    ('large', '480p'),
                    ('hd720', '720p'),
                    ('hd1080', '1080p'),
                    ('highres', 'Highest available')
                  ] %}
                  {% for qvalue, qlabel in options %}
                    <option value="{{ qvalue }}" {% if qual == qvalue %}selected{% endif %}>{{ qlabel }}</option>
                  {% endfor %}
                </select>
              </label>
            </div>
            <label style="display:block; margin-top:10px; color: var(--text-normal);">
              <input type="checkbox" name="{{ dname }}_save_web" value="1"> Save this URL
            </label>
            <small style="display:block; margin-top:5px; color: var(--text-normal);">
              Saved websites appear as suggestions for all displays.
            </small>
            <br><br>
          </div>

        </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <br>
    <div style="text-align:center;">
      <button type="submit">Save All</button>
    </div>
  </form>
  
  <!-- Bottom status row as its own card -->
  <div class="card" style="margin-top:20px; text-align:center; color: var(--text-normal);">
    <strong>Status:</strong>
    Spotify Status: {{ spotify_status }}
  </div>
</div>

{% endblock %}
